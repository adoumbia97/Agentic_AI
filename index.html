<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ðŸš€ Professional Agent App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <style>
    body { height:100vh; display:flex; flex-direction:column; }
    #chat { flex:1; overflow-y:auto; padding:1rem; background:#e9ecef; }
    .bubble { max-width:70%; padding:.75rem; border-radius:12px; }
    .bubble.user { background:#0d6efd; color:#fff; margin-left:auto;
                   border-bottom-right-radius:0; }
    .bubble.bot  { background:#f8f9fa; color:#212529; margin-right:auto;
                   border:1px solid #dee2e6; border-bottom-left-radius:0; }
    .timestamp { font-size:.75rem; color:#6c757d; }
    .form-control-sm { height: calc(1.5em + .5rem + 2px); }
    .btn-sm         { font-size:.875rem; padding:.25rem .5rem; }
  </style>
</head>
<body>

  <!-- NAVBAR with Tabs -->
  <nav class="navbar navbar-expand bg-dark navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Agent App</a>
      <ul class="nav nav-tabs ms-auto" id="mainTabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="tab-chat" data-bs-toggle="tab" href="#pane-chat">Chat</a>
        </li>
        <li class="nav-item">
          <a class="nav-link"    id="tab-admin" data-bs-toggle="tab" href="#pane-admin">Admin</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- LOGIN ROW -->
  <div class="container py-2">
    <div class="row g-2 align-items-center">
      <div class="col-auto">
        <select id="role-select" class="form-select form-select-sm">
          <option value="user" selected>User</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="col-auto">
        <input
          id="token-input"
          type="password"
          class="form-control form-control-sm"
          placeholder="API Key"
        />
      </div>
      <div class="col-auto">
        <button id="login-btn"  class="btn btn-sm btn-primary">Login</button>
        <button id="logout-btn" class="btn btn-sm btn-secondary" style="display:none;">
          Logout
        </button>
      </div>
      <div class="col-auto" id="user-ops" style="display:none;">
        <button id="new-conv" class="btn btn-sm btn-outline-secondary">New Conversation</button>
        <button id="usage-btn" class="btn btn-sm btn-outline-info">My Usage</button>
      </div>
      <div class="col-auto">
        <span id="user-label" class="fw-semibold"></span>
      </div>
    </div>
    <div id="alert-area" class="mt-2"></div>
  </div>

  <!-- TAB CONTENT -->
  <div class="tab-content flex-grow-1">
    <!-- CHAT PANE -->
    <div class="tab-pane fade show active h-100 d-flex flex-column" id="pane-chat">
      <div id="chat" class="flex-grow-1"></div>
      <div class="container py-2">
        <div class="input-group input-group-sm">
          <input
            id="msg-input"
            type="text"
            class="form-control form-control-sm"
            placeholder="Type your messageâ€¦"
            disabled
          />
          <button id="send-btn" class="btn btn-sm btn-success" disabled>Send</button>
        </div>
      </div>
    </div>

    <!-- ADMIN PANE -->
    <div class="tab-pane fade p-4" id="pane-admin">
      <h5>ðŸ”’ Admin Dashboard</h5>
      <table class="table table-bordered table-sm mt-3">
        <thead>
          <tr>
            <th>User</th>
            <th>Conversations</th>
            <th>Messages</th>
          </tr>
        </thead>
        <tbody id="admin-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  (function(){
    const roleSelect = document.getElementById('role-select');
    const tokenInput = document.getElementById('token-input');
    const loginBtn   = document.getElementById('login-btn');
    const logoutBtn  = document.getElementById('logout-btn');
    const alertArea  = document.getElementById('alert-area');
    const newConv    = document.getElementById('new-conv');
    const usageBtn   = document.getElementById('usage-btn');
    const userOps    = document.getElementById('user-ops');
    const userLabel  = document.getElementById('user-label');

    const msgInput   = document.getElementById('msg-input');
    const sendBtn    = document.getElementById('send-btn');
    const chatDiv    = document.getElementById('chat');
    const adminBody  = document.getElementById('admin-body');

    let ws, history = [];

    function showAlert(msg,type='danger') {
      alertArea.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show">
          ${msg}
          <button class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    }
    function clearAlert(){ alertArea.innerHTML = ''; }

    function appendBubble(who,text,ts){
      const wrap = document.createElement('div');
      const b    = document.createElement('div');
      b.className = 'bubble ' + who;
      b.textContent = text;
      const t = document.createElement('div');
      t.className = 'timestamp';
      t.textContent = new Date(ts).toLocaleTimeString([], {
        hour:'2-digit',minute:'2-digit'
      });
      wrap.append(b,t);
      chatDiv.append(wrap);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function setLoggedIn(role, username){
      roleSelect.disabled = true;
      tokenInput.disabled  = true;
      loginBtn.style.display  = 'none';
      logoutBtn.style.display = 'inline-block';
      clearAlert();
      userLabel.textContent = role === 'user'
                           ? `ðŸ‘¤ ${username}`
                           : `ðŸ”‘ Admin: ${username}`;

      if(role==='user'){
        userOps.style.display = 'inline-flex';
        msgInput.disabled = false;
        sendBtn.disabled  = false;
        // load past history
        fetch(`/history?access_token=${localStorage.app_token}`)
          .then(r=>r.json())
          .then(d=>{
            history = d.history;
            chatDiv.innerHTML = '';
            history.forEach(m=>appendBubble(m.who,m.text,m.ts));
          });
        // connect WS
        ws = new WebSocket(`ws://${location.host}/ws/chat?access_token=${localStorage.app_token}`);
        ws.onmessage = e=>{
          const {reply} = JSON.parse(e.data);
          const ts = Date.now();
          history.push({who:'bot',text:reply,ts});
          appendBubble('bot',reply,ts);
        };
        ws.onclose = ev=>{
          if(ev.code===1008){
            showAlert('âŒ Invalid API Key â€“ please login again.','warning');
            setLoggedOut();
          }
        };
      } else {
        userOps.style.display = 'none';
        msgInput.disabled = true;
        sendBtn.disabled  = true;
        // load admin usage
        fetch(`/admin/usage?access_token=${localStorage.app_token}`)
          .then(r=>{
            if(!r.ok) throw 0;
            return r.json();
          })
          .then(d=>{
            adminBody.innerHTML = '';
            Object.entries(d.usage).forEach(([u,st])=>{
              adminBody.insertAdjacentHTML('beforeend',`
                <tr>
                  <td>${u}</td>
                  <td>${st.conversations}</td>
                  <td>${st.messages}</td>
                </tr>`);
            });
          })
          .catch(_=> {
            showAlert('âŒ Invalid admin key â€“ please login again.','warning');
            setLoggedOut();
          });
      }
    }

    function setLoggedOut(){
      localStorage.removeItem('app_token');
      localStorage.removeItem('app_role');
      roleSelect.disabled = false;
      tokenInput.disabled = false;
      loginBtn.style.display  = 'inline-block';
      logoutBtn.style.display = 'none';
      userOps.style.display   = 'none';
      msgInput.disabled = true;
      sendBtn.disabled  = true;
      userLabel.textContent = '';
      chatDiv.innerHTML = '';
      adminBody.innerHTML = '';
      clearAlert();
      if(ws) ws.close();
      history = [];
    }

    // send message
    sendBtn.onclick = ()=>{
      const txt = msgInput.value.trim();
      if(!txt) return;
      const ts = Date.now();
      history.push({who:'user',text:txt,ts});
      appendBubble('user',txt,ts);
      ws.send(JSON.stringify({message:txt}));
      msgInput.value = '';
    };

    // new conversation
    newConv.onclick = ()=>{
      history=[];
      chatDiv.innerHTML='';
      if(ws) ws.close();
      // force new convo on server
      setLoggedIn('user', localStorage.getItem('app_username'));
    };

    // view usage
    usageBtn.onclick = ()=>{
      fetch(`/usage?access_token=${localStorage.app_token}`)
        .then(r=>r.json())
        .then(d=> showAlert(
           `ðŸ“Š ${d.username}: convs=${d.conversations}, msgs=${d.messages}`,
           'info'
        ));
    };

    // login flow
    loginBtn.onclick = async ()=>{
      const token = tokenInput.value.trim();
      const role  = roleSelect.value;
      if(!token){
        showAlert('API Key cannot be empty.');
        return;
      }
      // choose correct endpoint
      const path = role==='user'
                 ? `/usage?access_token=${token}`
                 : `/admin/usage?access_token=${token}`;
      try {
        const resp = await fetch(path);
        if(!resp.ok) throw 0;
        const data = await resp.json();
        // save token & role & username
        localStorage.app_token    = token;
        localStorage.app_role     = role;
        localStorage.app_username = data.username;
        tokenInput.value = '';
        setLoggedIn(role, data.username);
      } catch {
        showAlert('âŒ Invalid API Key â€” please try again.', 'warning');
      }
    };

    logoutBtn.onclick = setLoggedOut;

    // on load: restore session
    window.addEventListener('load',()=>{
      const tok  = localStorage.app_token;
      const role = localStorage.app_role;
      const user = localStorage.app_username;
      if(tok && role && user){
        setLoggedIn(role, user);
      }
    });

  })();
  </script>
</body>
</html>
